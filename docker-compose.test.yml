version: "3.9"

# Extension untuk testing - gunakan dengan: docker compose -f docker-compose.yml -f docker-compose.test.yml up

services:
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    image: uas-test:latest
    depends_on:
      aggregator:
        condition: service_healthy
      storage:
        condition: service_healthy
      broker:
        condition: service_started
    environment:
      - DATABASE_URL=postgresql+psycopg2://user:pass@storage:5432/uasdb
      - REDIS_URL=redis://broker:6379/0
      - AGGREGATOR_URL=http://aggregator:8080
      - USE_INMEMORY_QUEUE=0
      - DISABLE_WORKERS=1
    volumes:
      - ./tests:/app/tests:ro
      - ./aggregator:/app/aggregator:ro
    command: pytest -v --tb=short
    profiles:
      - test

